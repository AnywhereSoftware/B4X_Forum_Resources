### [Server] Building web servers with B4J by Erel
### 09/01/2021
[B4X Forum - B4J - Tutorials](https://www.b4x.com/android/forum/threads/37172/)

**Edit: Web Apps tutorial: <http://www.b4x.com/android/forum/threads/webapp-web-apps-overview.39811/>**  
  
The server implementation is based on a popular and powerful Java server library named [Jetty](http://www.eclipse.org/jetty/) ([license](http://www.eclipse.org/jetty/licenses.php))  
The database connection pooling implementation is based on [c3p0](http://www.mchange.com/projects/c3p0/) ([license](http://www.gnu.org/licenses/lgpl-2.1.html)).  
  
  
B4J Server features:  

- High performance web server
- Automatic handling of static files
- Simple to develop custom "handlers"
- Support for GET, POST, DELETE and PUT requests
- Support for multipart requests (file uploads)
- Standard logging
- Each handler can either be multi-threaded or single-threaded
- Simple and powerful database connections pooling
- Server can run on Windows, Mac and Linux (including board computers such as Raspberry Pi)

  
**Possible usages**  

- Internal or external web sites
- Backend solutions (with or without UI) that can optionally connect to any type of database

  
  
If you never worked with web servers then it is recommended to start with a HTTP tutorial such as this one: <http://net.tutsplus.com/tutorials/tools-and-tips/http-the-protocol-every-web-developer-must-know-part-1/>  
  
I also recommend you to use a proper browser with debugging plugin such as FireFox + FireBug. The ability to inspect the requests and responses is very useful.  
  
**How it works**  
  
A server program is a non-UI program.  
In the Main module you should create a Server object, configure it, start it and call StartMessageLoop:  

```B4X
Sub Process_Globals  
   Private srvr As Server  
End Sub  
  
Sub AppStart (Args() As String)  
   srvr.Initialize("srvr")  
   srvr.Port = 8888  
   srvr.StaticFilesFolder = File.Combine(File.DirApp, "www")  
   srvr.AddHandler("/hello", "HelloPage", False)  
   srvr.AddHandler("/FormExampleHelper", "FormExampleHelper", False)  
   srvr.AddHandler("/FileUpload", "FileUpload", False)  
   srvr.Start  
   StartMessageLoop  
End Sub
```

  
  
As you can see in the above code, the port is set to 8888.  
StaticFilesFolder sets the folder (and subfolders) that will be used to serve static files. Any file that is not generated by your code is a static file (html, js, css, images, etc.).  
Files outside of this folder cannot be accessed. This is important for security reasons.  
Note that if the url points to a folder then the index.html file in that folder will be served (if it exists).  
  
**Handlers**  
  
A handler is a B4J class that is mapped to a URL. A handler class is responsible for getting the request and providing the response.  
  
Each request is handled by a new instance of the handler class. A handler class should have an empty Initialize and a Handle sub with the following signature:  

```B4X
Sub Handle(req As ServletRequest, resp As ServletResponse)
```

  
  
You should read the data from the ServletRequest and write the response to the ServletResponse.  
  
For example:  

```B4X
Sub Handle(req As ServletRequest, resp As ServletResponse)  
resp.Write("Hello World!")  
End Sub
```

  
  
The attached example includes three handlers:  
*HelloPage **-*** A simple handler that creates the following page:  
  
![](http://www.b4x.com/basic4android/images/SS-2014-01-27_16.49.30.png)  
Note that this page was served from a Raspberry Pi board :)  
  
*FormExampleHelper **-*** This handler receives a submitted form and prints the form's fields. It is used by two html pages. A simple form page and a page that uses Ajax (with JQuery) to send the form.  
  
*FileUpload* - This handler receives a multipart form with a file and other fields. It logs the fields and the file size.  
  
**Threading**  
  
When you add a handler you need to specify whether you want it to be a single threaded handler or a multithreaded handler. By default you should use multithreaded handlers (third parameter should be false).  
  
A multithreaded handler means that your handler code will be run by a thread from the server threads pool. Multiple instances of the same handler and other handlers can be executed in the same time. As long as you don't access any global variable out of the current handler instance you should be safe.  
  
A single threaded handler will always be executed by the main thread. This means that if there are multiple requests they will be queued and executed one by one. Single threaded handlers can be useful in many cases. Some examples:  
- A handler that accesses a SQLite database, which is less suitable for concurrent connections. See this tutorial for concurrent access to SQLite: <https://www.b4x.com/android/forum/threads/webapp-concurrent-access-to-sqlite-databases.39904/#content>  
- A handler that writes to a specific file.  
- A handler that sends a job to the printer  
  
Note that when you run your code in Debug mode the handlers will always run in the main thread.  
  
**Datebase Connections Pooling**  
  
Many web servers are based on databases. Databases, such as MySQL and others, can properly handle concurrent queries and transactions. The ConnectionPool object handles a pool of database connections. You can then get a connection (SQL object) from the pool, work with it and close it, which will actually return it to the pool.  
  
The pool is responsible for maintaining the connections.  
An alternative for a connections pool is a process global SQL variable. However for it to work properly all the handlers should be single threaded handlers.  
  
As explained in the SQL tutorial you should use #AdditionalJar attribute to add a reference to the JDBC jar. You should then make a public process global pool variable and use it from the handler.  
  
  
To try this example, run it from B4J and point the browser to 127.0.0.1:8888  
This will load the index.html file that is available in the www folder.  
  
**Examples & Tutorials:**   
  
Online examples: <https://www.b4x.com:51041>  
[SIZE=3]Other server tutorials: <http://www.b4x.com/android/forum/pages/results/?query=[server]&page=1&prefix=0>[/SIZE]