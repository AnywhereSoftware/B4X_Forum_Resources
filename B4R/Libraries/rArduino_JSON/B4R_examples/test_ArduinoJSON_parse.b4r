Build1=Default,B4RDev
Group=Default Group
Library1=rcore
Library2=rarduino_json
NumberOfFiles=0
NumberOfLibraries=2
NumberOfModules=0
Version=4
@EndOfDesignText@

#Region Project Attributes
	#AutoFlushLogs: True
	#CheckArrayBounds: True
	#StackBufferSize: 2600
#End Region
'Ctrl+Click to open the C code folder: ide://run?File=%WINDIR%\System32\explorer.exe&Args=%PROJECT%\Objects\Src

Sub Process_Globals
	Public Serial1 As Serial
'	Private wifi As ESP8266WiFi 
'	Private JSON2 As B4RJSON
	Private jvar0, jvar1, jvar2, jvar3, jvar4, jvar5, jvar6, jvar7, jvar8, jvar9, jvar10, jvar11, jvar12 As JSONVar
	Private tmp1, tmp2 As JSONVar
	Private tempo As Int = 1000
End Sub

Private Sub AppStart
	Serial1.Initialize(115200)
	Log("AppStart")
	'example of connecting to a local network
'	If wifi.Connect2("SSID", "PASSWORD") Then
'		Log("Connected to network")
'	Else
'		Log("Failed to connect to network")
'	End if
'	basic_json
	
'	array_json
	
	object_json
	
Log("end")
End Sub




Sub basic_json
	Delay(tempo): Log(" "):Log(" create JsonVar")
	create_json
	Delay(tempo): Log(" "):Log(" read JsonVar")
	log_json
	Delay(tempo): Log(" "):Log(" modif JsonVar")
	modif_json
	Delay(tempo): Log(" "):Log(" read JsonVar")
	log_json
End Sub	

Sub array_json
	Delay(tempo): Log(" "):Log(" create Array")
	create_Array
	Delay(tempo): Log(" "):Log(" readArray")
	read_Array
	
	Delay(tempo): Log(" "):Log(" log Array_parse")
	parse_json(jvar0)
	
	Delay(tempo):Log(" "):Log(" log Modif_Array_parse")
	modif_Array
	
	Delay(tempo):Log(" "):Log(" log modif_array parse")
	parse_json(jvar0)
End Sub	

Sub object_json
	Delay(tempo): Log(" "):Log(" create Object")
	create_Object
	
	Delay(tempo): Log(" "):Log(" readObject")
	read_Object
	
	Delay(tempo): Log(" "):Log(" Object parse jvar11")
	parse_json(jvar11)
	Delay(tempo): Log(" "):Log(" Object parse jvar12")
	parse_json(jvar12)
		
	Delay(tempo): Log(" "):Log(" Modif Object")
	modif_Object
	
	Delay(tempo): Log(" "):Log(" read Object after Modif")
	read_Object

	Delay(tempo): Log(" "):Log(" log Array_parse")
	parse_json(jvar11)
End Sub	





		
Sub create_json
	jvar1.setBool(Array(0),True)
	jvar2.setNumberL(Array(0),55)
	jvar3.setNumberL(Array(0),0xFFFFFFFF)
	jvar4.setNumberL(Array(0),1055)
	jvar5.setNumberL(Array(0),-35001055)
	jvar6.setNumberUL(Array(0),4294967295)
	jvar7.setNumberD(Array(0),42.56)
	jvar9.setString(Array(0),"azerty azerty")
			
	jvar10.setJsonVar(Array(0),jvar2)
	jvar11.setNumberL(Array(0),123456)
End Sub

Sub modif_json
	jvar10.setString(Array(0),"array modif")
	jvar11.setNull(Array(0))
End Sub

Sub log_json
	Log("jvar1 bool -> ",jvar1.getBool(Array(0)))
	Log("jvar2 Byte -> ",jvar2.getNumberL(Array(0)))
	Log("jvar3 Int -> ",jvar3.getNumberL(Array(0)))
	Log("jvar4 UInt -> ", jvar4.getNumberL(Array(0)))
	Log("jvar5 Long ->", jvar5.getNumberL(Array(0)))
	Log("jvar6 ULong -> ", jvar6.getNumberUL(Array(0)))
	Log("jvar7 Double= -> ",jvar7.getNumberD(Array(0)))
	Log("jvar9 String -> ",jvar9.getString(Array(0)))
	If jvar10.typeof(Array(0))= "number" Then
		Log("jvar10 jvar -> ",jvar10.getNumberL(Array(0)))
	Else
		Log("jvar10 jvar -> ",jvar10.getString(Array(0)))
	End	if	
	Log("jvar11 jvar -> ",jvar11.getNumberL(Array(0)))
End Sub






Sub create_Array
	jvar0.setNumberL(Array(1,0),124)
	jvar0.setString(Array(1,1),"la suite")
	jvar0.setNumberD(Array(1,2),43.752)
	jvar0.setString(Array(1,3),"comment ca code")
	jvar0.setNumberL(Array(1,4),0xFFFFFFFE)
	jvar0.setNumberUL(Array(1,5),3000007290)
	jvar0.setString(Array(1,6),"c'est la fin")
	Log("jvar0 : ",jvar0.stringify(Array(0)),CRLF)
End Sub

Sub modif_Array
	jvar0.setString(Array(2,4,0),"test0")
	jvar0.setString(Array(2,4,1),"test1")
	jvar0.setString(Array(2,4,2),"test2")
	jvar0.setString(Array(3,5,0,0),"retest0")
	jvar0.setString(Array(3,5,0,1),"retest1")
	Log("jvar0 : ",jvar0.stringify(Array(0)),CRLF)	
End Sub

Sub read_Array
	Log("Jvar0 typeoff :",jvar0.typeof(Array(0)))
	Log("load array[0]  Number -> ",jvar0.getNumberL(Array(1,0)))
	Log("load array[1]  String -> ",jvar0.getString(Array(1,1)))
	Log("load array[2]  Double -> ",jvar0.getNumberD(Array(1,2)))
	Log("load array[3]  String -> ",jvar0.getString(Array(1,3)))
	If jvar0.typeof(Array(1,4)) = "number" Then
	Log("load array[4]  Long   : ",jvar0.getNumberL(Array(1,4)))
	Else
	Log("load array[4.0]  String : ",jvar0.getString(Array(2,4,0)))
	Log("load array[4.1]  String : ",jvar0.getString(Array(2,4,1)))
	Log("load array[4.2]  String : ",jvar0.getString(Array(2,4,2)))
	End If
	If jvar0.typeof(Array(1,5)) = "number" Then
	Log("load array[5]  ULong  -> ",jvar0.getNumberUL(Array(1,5)))
	Else
	Log("load array[5.0.0]  String : ",jvar0.getString(Array(3,5,0,0)))
	Log("load array[5.0.1]  String : ",jvar0.getString(Array(3,5,0,1)))
	End If
	Log("load array[6]  String -> ",jvar0.getString(Array(1,6)))
End Sub






Sub create_Object
	jvar11.setString(Array(1,"Obj_1"),"tutu") 
	jvar11.setString(Array(1,"Obj_10"),"tuto") 
	jvar11.setNumberL(Array(2,"Obj_2.1","Obj_2.2"),320000)

	jvar12.setString(Array(1,"Obj_3"),"Str_content_3")
	jvar12.setString(Array(2,"Obj_4.1","Obj_4.2"),"Str_content_4")
	jvar12.setString(Array(3,"Obj_5.1","Obj_5.2","Obj_5.3"),"Str_content_5")
	jvar12.setString(Array(3,"Obj_6.1","Obj_6.2","Obj_6.3"),"Str_content_6")
	jvar12.setNumberUL(Array(1,"Obj_7.1"),3131313131)
	jvar12.setNumberUL(Array(2,"Obj_8",0),1955)
	jvar12.setNumberUL(Array(2,"Obj_8",1),1956)
End Sub

Sub modif_Object
    jvar11.setnumberl(Array(2,"Obj_10","Obj_11"),-2700)
	jvar11.setString(Array(2,"Obj_1","Obj_10"),"modif_Obj 1")
	jvar11.setString(Array(2,"Obj_1","Obj_11"),"modif_Obj 2")
End Sub

Sub read_Object
	Log("Jvar11 typeoff :",jvar11.typeof(Array(0)))
	If jvar11.typeof(Array(1,"Obj_1"))="string" Then
		Log("load Object[11] Obj_1 -> ",              jvar11.getString(Array(1,"Obj_1")))
	Else
		Log("load Object[11] Obj_1 Obj_10 -> ",       jvar11.getString(Array(2,"Obj_1","Obj_10")))
		Log("load Object[11] Obj_1 Obj_10 -> ",       jvar11.getString(Array(2,"Obj_1","Obj_11")))
	End If
	If jvar11.typeof(Array(1,"Obj_10"))="string" Then
		Log("load Object[11] Obj_10 -> ",             jvar11.getString(Array(1,"Obj_10")))
	Else
		Log("load Object[11] Obj_10 Obj_11-> ",       jvar11.getNumberL(Array(2,"Obj_10","Obj_11")))
	End If
	Log("load Object[11] Obj_2.1 Obj_2.2 -> ",        jvar11.getNumberD(Array(2,"Obj_2.1","Obj_2.2")))

	Log("Jvar12 typeoff :",jvar12.typeof(Array(0)))
	Log("load Object[12] Obj_3 : ",                   jvar12.getString(Array(1,"Obj_3")))
	Log("load Object[12] Obj4.1 Obj_4.2 -> ",         jvar12.getString(Array(2,"Obj_4.1","Obj_4.2")))
	Log("load Object[12] Obj_5.1 Obj_5.2 Obj_5.3 -> ",jvar12.getString(Array(3,"Obj_5.1","Obj_5.2","Obj_5.3")))
	Log("load Object[12] Obj_6.1 Obj_6.2 Obj_6.3 -> ",jvar12.getString(Array(3,"Obj_6.1","Obj_6.2","Obj_6.3")))
	Log("case Number > 7FFF FFFF and read example with Long/ULong/Double")
	Log("load Object[12] Obj_7.1 D-> ",               jvar12.getNumberD(Array(1,"Obj_7.1")))
	Log("load Object[12] Obj_7.1 L-> ",               jvar12.getNumberL(Array(1,"Obj_7.1")))
	Log("load Object[12] Obj_7.1 UL-> ",              jvar12.getNumberUL(Array(1,"Obj_7.1")))
	Log("load Object[12] Obj_8 UL-> ",                jvar12.getNumberUL(Array(1,"Obj_8")))
End Sub






Sub parse_json(jsv As JSONVar)
	Dim jsv_str As String = jsv.stringify(Array(0))
	tmp1.parse(jsv_str)
'	Log(" json to parse :",tmp1.typeof(Array(0)))
	Select tmp1.typeof(Array(0))
		Case "boolean"
			Log ("tmp1 = ",tmp1.getbool(Array(0)))
		Case "number"
			Log ("tmp1 = ",tmp1.getNumberD(Array(0)))
		Case "string" 
			Log ("tmp1 = ",tmp1.getString(Array(0)))
		Case "null"
			Log ("tmp1 = null")
		Case "undefined"
			Log ("tmp1 = undefined")
		Case "array"
			parse_array(tmp1, Array(0))
		Case "object"
			parse_object(tmp1, Array(0))		
	End Select
End Sub

Sub parse_array(jsv As JSONVar,keys() As Object)	
	Dim i As Int:Dim keys2(9) As Object:Dim arrayNb As Int = jsv.Length(keys)
	Log("*** run_Parse Array ",jsv.stringify(keys),CRLF)	

	For i=0 To keys(0): keys2(i)=keys(i): Next: keys2(0)=keys(0)+1
  	For i = 0 To arrayNb-1
		keys2(keys2(0))=i
		Select jsv.typeof(keys2)
			Case "boolean"
				Log ("json(",i,") = ",jsv.getbool(keys2))
			Case "number"
				Log ("json(",i,") = ",jsv.getNumberD(keys2))
			Case "string"
				Log ("json(",i,") = ",jsv.getString(keys2))
			Case "null"
				Log ("json(",i,") = null")
			Case "undefined"
				Log ("json(",i,") = undefined")
			Case "array"
				Log ("json(",i,") = Array")
				parse_array(jsv, keys2)
			Case "object"
				Log ("json(",i,") = Object")
				parse_object(jsv, keys2)
		End Select  	
  	Next
End Sub	
		
Sub parse_object(jsv As JSONVar,keys() As Object)	
	Log("*** run_Parse object ",jsv.stringify(keys),CRLF)
	Dim i As Int : Dim lst(10) As String: Dim keys2(9) As Object: Dim ObjNb As Int
	jsv.keys(keys, tmp2)	
	ObjNb = tmp2.Length(Array(0))
	For i = 0 To ObjNb-1
	  	lst(i)=tmp2.getString((Array(1,i)))
	Next
	tmp2.setNull(Array(0))	
	For i=0 To keys(0): keys2(i)=keys(i): Next: keys2(0)=keys(0)+1	
	For i = 0 To (ObjNb-1)
		keys2(keys2(0))=lst(i)
		Select jsv.typeof(keys2)
			Case "boolean"
				Log ("json(",lst(i),") = ",jsv.getbool(keys2))
			Case "number"
				Log ("json(",lst(i),") = ",jsv.getNumberD(keys2))
			Case "string"
				Log ("json(",lst(i),") = ",jsv.getString(keys2))
			Case "null"
				Log ("json(",lst(i),") = null")
			Case "undefined"
				Log ("json(",lst(i),") = undefined")
			Case "array"
				Log ("json(",lst(i),") = Array")
				parse_array(jsv, keys2)
			Case "object"
				Log ("json(",lst(i),") = Object")
				parse_object(jsv, keys2)
		End Select
	Next
End Sub
